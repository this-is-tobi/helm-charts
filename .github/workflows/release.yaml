name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checks-out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Add Helm repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add cnpg https://cloudnative-pg.github.io/charts
          helm repo add hashicorp https://helm.releases.hashicorp.com

      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --import --batch --no-tty
          gpg --list-secret-keys
          
          # Export keys in legacy GPG format for Helm compatibility
          # Per Helm docs: https://helm.sh/docs/topics/provenance/
          # GPG 2.1+ uses new format (kbx), but Helm requires legacy format with separate files:
          # - pubring.gpg: public keys only
          # - secring.gpg: secret keys only
          gpg --batch --yes --export > "$HOME/.gnupg/pubring.gpg"
          echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --export-secret-keys > "$HOME/.gnupg/secring.gpg"
          
          # Verify files were created
          ls -la "$HOME/.gnupg/"
          
          # Create passphrase file for helm signing
          echo "${{ secrets.GPG_PASSPHRASE }}" > /tmp/passphrase.txt
          chmod 600 /tmp/passphrase.txt

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1
        id: chart-releaser
        with:
          charts_dir: charts
          config: ci/configs/cr.yaml
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_KEY: "Tobi (Helm Charts) <this-is-tobi@proton.me>"
          CR_KEYRING: ~/.gnupg/secring.gpg
          CR_PASSPHRASE_FILE: /tmp/passphrase.txt
          CR_SIGN: "true"

      - name: Login to GitHub Container Registry
        if: steps.chart-releaser.outputs.changed_charts != ''
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Install Cosign for OCI signing
        if: steps.chart-releaser.outputs.changed_charts != ''
        uses: sigstore/cosign-installer@v3

      - name: Publish and sign charts to OCI registry
        if: steps.chart-releaser.outputs.changed_charts != ''
        run: |
          # Only process charts that were actually released
          for chart_package in .cr-release-packages/*.tgz; do
            if [ ! -f "$chart_package" ]; then
              echo "No charts to publish"
              continue
            fi
            
            chart_file=$(basename "$chart_package")
            chart_name="${chart_file%-*}"
            
            # Push to GHCR (skip if already exists)
            echo "Publishing ${chart_file} to OCI registry..."
            if output=$(helm push "$chart_package" oci://ghcr.io/${{ github.repository }} 2>&1); then
              echo "$output"
              digest=$(echo "$output" | grep "Digest:" | awk '{print $2}')
              
              # Sign the OCI artifact with Cosign
              echo "Signing OCI artifact with digest: ${digest}"
              cosign sign --yes "ghcr.io/${{ github.repository }}/${chart_name}@${digest}"
              
              echo "✓ Published and signed ${chart_file}"
            elif echo "$output" | grep -q "already exists\|409"; then
              echo "⊘ ${chart_file} already exists in OCI registry, skipping"
            else
              echo "✗ Failed to push ${chart_file}"
              echo "$output"
              exit 1
            fi
          done
        env:
          COSIGN_EXPERIMENTAL: 1
