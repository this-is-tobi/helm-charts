apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: {{ include "template.fullname" . }}
  labels: {{- include "template.labels" . | nindent 4 }}
  {{- if .Values.annotations }}
  annotations: {{- toYaml .Values.annotations | nindent 4 }}
  {{- end }}
spec:
  instances: {{ .Values.instances }}
  {{- if .Values.imageName }}
  imageName: {{ .Values.imageName }}
  {{- end }}
  imagePullPolicy: {{ .Values.imagePullPolicy }}
  {{- if and .Values.imageCredentials.username .Values.imageCredentials.password }}
  imagePullSecrets:
  - name: {{ printf "%s-%s" (include "template.fullname" .) "pullsecret" }}
  {{- end }}
  postgresql:
    {{- if .Values.parameters }}
    parameters: {{- toYaml .Values.parameters | nindent 6 }}
    {{- end }}
    {{- if .Values.pgHba }}
    pg_hba: {{- toYaml .Values.pgHba | nindent 6 }}
    {{- end }}
  enableSuperuserAccess: {{ .Values.enableSuperuserAccess }}
  superuserSecret:
    {{- if eq .Values.credentials.existingSecrets.enabled false }}
    name: {{ printf "%s-%s" (include "template.fullname" .) "admin" }}
    {{- else }}
    name: {{ .Values.credentials.existingSecrets.postgres.secretName }}
    {{- end }}
  primaryUpdateStrategy: {{ .Values.primaryUpdateStrategy }}
  storage:
    size: {{ .Values.pvcSize.data }}
    {{- if .Values.storageClass }}
    storageClass: {{ .Values.storageClass | quote }}
    {{- end }}
  {{- if .Values.pvcSize.wal }}
  walStorage:
    size: {{ .Values.pvcSize.wal }}
    {{- if .Values.storageClass }}
    storageClass: {{ .Values.storageClass | quote }}
    {{- end }}
  {{- end }}
  resources: {{- toYaml .Values.resources | nindent 4 }}
  {{/* DEPRECATED: Legacy in-tree backup (defined in _helpers.tpl). Remove when CNPG drops support. */}}
  {{- include "template.legacy.backup" . | nindent 2 }}
  {{- if eq .Values.mode "primary" }}
  bootstrap:
    initdb:
      database: {{ .Values.dbName | default (include "template.fullname" .) }}
      owner: {{ .Values.credentials.username | default (include "template.fullname" .) }}
      secret:
        {{- if eq .Values.credentials.existingSecrets.enabled false }}
        name: {{ printf "%s-%s" (include "template.fullname" .) "app" }}
        {{- else }}
        name: {{ .Values.credentials.existingSecrets.app.secretName }}
        {{- end }}
      {{- if .Values.initDb.extraArgs }}
      {{- toYaml .Values.initDb.extraArgs | nindent 6 }}
      {{- end }}
  {{- else if eq .Values.mode "recovery" }}
  bootstrap:
    recovery:
      source: {{ .Values.recovery.clusterName | default (include "template.fullname" .) }}
      database: {{ .Values.dbName | default (include "template.fullname" .) }}
      owner: {{ .Values.credentials.username | default (include "template.fullname" .) }}
      secret:
        {{- if eq .Values.credentials.existingSecrets.enabled false }}
        name: {{ printf "%s-%s" (include "template.fullname" .) "app" }}
        {{- else }}
        name: {{ .Values.credentials.existingSecrets.app.secretName }}
        {{- end }}
      {{- if .Values.recovery.extraArgs }}
      {{- toYaml .Values.recovery.extraArgs | nindent 6 }}
      {{- end }}
  externalClusters:
  - name: {{ .Values.recovery.clusterName | default (include "template.fullname" .) }}
    plugin:
      name: barman-cloud.cloudnative-pg.io
      parameters:
        barmanObjectName: {{ printf "%s-%s" (include "template.fullname" .) "backup-store" }}
        serverName: {{ .Values.recovery.clusterName | default (include "template.fullname" .) }}
  {{- else if eq .Values.mode "replica" }}
  bootstrap:
    recovery:
      source: {{ .Values.replica.clusterName | default (include "template.fullname" .) }}
      {{- if .Values.replica.extraArgs }}
      {{- toYaml .Values.replica.extraArgs | nindent 6 }}
      {{- end }}
  replica:
    enabled: true
    source: {{ .Values.replica.clusterName | default (include "template.fullname" .) }}
  externalClusters:
  - name: {{ .Values.replica.clusterName | default (include "template.fullname" .) }}
    plugin:
      name: barman-cloud.cloudnative-pg.io
      parameters:
        barmanObjectName: {{ printf "%s-%s" (include "template.fullname" .) "replica-store" }}
        serverName: {{ .Values.replica.clusterName | default (include "template.fullname" .) }}
    {{- if .Values.replica.host }}
    connectionParameters:
      host: {{ .Values.replica.host }}
      port: {{ .Values.replica.port | default 5432 | quote }}
      dbname: {{ .Values.replica.dbName }}
      sslmode: {{ .Values.replica.sslMode }}
    {{- end }}
  {{- end }}
  {{/* Plugin-based backup and replica configuration (official barman-cloud plugin method) */}}
  {{- if or (and .Values.backup.enabled (not .Values.backup.legacyMode)) (eq .Values.mode "replica") }}
  plugins:
  {{- if and .Values.backup.enabled (not .Values.backup.legacyMode) }}
  - name: barman-cloud.cloudnative-pg.io
    isWALArchiver: true
    parameters:
      barmanObjectName: {{ printf "%s-%s" (include "template.fullname" .) "backup-store" }}
  {{- end }}
  {{- if eq .Values.mode "replica" }}
  - name: barman-cloud.cloudnative-pg.io
    parameters:
      barmanObjectName: {{ printf "%s-%s" (include "template.fullname" .) "replica-store" }}
  {{- end }}
  {{- end }}
  monitoring:
    enablePodMonitor: {{ .Values.monitoring.enabled }} 
  logLevel: {{ .Values.logLevel }}
  {{- if .Values.affinity }}
  affinity: {{- toYaml .Values.affinity | nindent 4 }}
  {{- end }}
  {{- if .Values.topologySpreadConstraints }}
  topologySpreadConstraints: {{- toYaml .Values.topologySpreadConstraints | nindent 4 }}
  {{- end }}
