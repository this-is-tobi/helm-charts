{{/*
Plugin-based replica ObjectStore resource.
Only created in replica mode using the official barman-cloud plugin architecture.
*/}}
{{- if eq .Values.mode "replica" }}
apiVersion: barmancloud.cnpg.io/v1
kind: ObjectStore
metadata:
  name: {{ printf "%s-%s" (include "template.fullname" .) "replica-store" }}
  labels: {{- include "template.labels" . | nindent 4 }}
  {{- if .Values.annotations }}
  annotations: {{- toYaml .Values.annotations | nindent 4 }}
  {{- end }}
spec:
  configuration:
    destinationPath: {{ .Values.replica.destinationPath }}
    endpointURL: {{ .Values.replica.endpointURL }}
    {{- if or .Values.replica.endpointCA.create .Values.replica.endpointCA.secretName }}
    endpointCA:
      name: {{ .Values.replica.endpointCA.secretName | default (printf "%s-%s" (include "template.fullname" .) "replica-ca") }}
      key: {{ .Values.replica.endpointCA.key }}
    {{- end }}
    s3Credentials:
      accessKeyId:
        name: {{ .Values.replica.s3Credentials.secretName | default (printf "%s-%s" (include "template.fullname" .) "replica-creds") }}
        key: {{ .Values.replica.s3Credentials.accessKeyId.key }}
      secretAccessKey:
        name: {{ .Values.replica.s3Credentials.secretName | default (printf "%s-%s" (include "template.fullname" .) "replica-creds") }}
        key: {{ .Values.replica.s3Credentials.secretAccessKey.key }}
      region:
        name: {{ .Values.replica.s3Credentials.secretName | default (printf "%s-%s" (include "template.fullname" .) "replica-creds") }}
        key: {{ .Values.replica.s3Credentials.region.key }}
{{- end }}